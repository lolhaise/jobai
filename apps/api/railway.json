{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pnpm install && pnpm build",
    "watchPatterns": [
      "apps/api/**",
      "packages/**"
    ]
  },
  
  "deploy": {
    "startCommand": "pnpm start:prod",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 10,
    "numReplicas": 2,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  },
  
  "env": {
    "NODE_ENV": "production",
    "PORT": "${{PORT}}",
    "DATABASE_URL": "${{DATABASE_URL}}",
    "REDIS_URL": "${{REDIS_URL}}",
    "JWT_SECRET": "${{JWT_SECRET}}",
    "JWT_EXPIRATION": "30d",
    "OPENAI_API_KEY": "${{OPENAI_API_KEY}}",
    "ANTHROPIC_API_KEY": "${{ANTHROPIC_API_KEY}}",
    "ENCRYPTION_KEY": "${{ENCRYPTION_KEY}}",
    "SMTP_HOST": "${{SMTP_HOST}}",
    "SMTP_PORT": "${{SMTP_PORT}}",
    "SMTP_USER": "${{SMTP_USER}}",
    "SMTP_PASS": "${{SMTP_PASS}}",
    "SMTP_FROM": "${{SMTP_FROM}}",
    "CORS_ORIGINS": "https://jobai.app,https://www.jobai.app",
    "RATE_LIMIT_MAX": "100",
    "RATE_LIMIT_WINDOW": "60000",
    "GOOGLE_CALENDAR_CLIENT_ID": "${{GOOGLE_CALENDAR_CLIENT_ID}}",
    "GOOGLE_CALENDAR_CLIENT_SECRET": "${{GOOGLE_CALENDAR_CLIENT_SECRET}}",
    "OUTLOOK_CLIENT_ID": "${{OUTLOOK_CLIENT_ID}}",
    "OUTLOOK_CLIENT_SECRET": "${{OUTLOOK_CLIENT_SECRET}}",
    "USAJOBS_API_KEY": "${{USAJOBS_API_KEY}}",
    "THE_MUSE_API_KEY": "${{THE_MUSE_API_KEY}}",
    "SENTRY_DSN": "${{SENTRY_DSN}}",
    "NEW_RELIC_LICENSE_KEY": "${{NEW_RELIC_LICENSE_KEY}}"
  },
  
  "services": [
    {
      "name": "api",
      "source": "./",
      "domains": [
        {
          "domain": "api.jobai.app"
        }
      ],
      "healthcheck": {
        "type": "http",
        "path": "/health",
        "interval": 30,
        "timeout": 10,
        "retries": 3
      },
      "scaling": {
        "minInstances": 1,
        "maxInstances": 10,
        "targetCPU": 70,
        "targetMemory": 80
      },
      "resources": {
        "limits": {
          "memory": "1Gi",
          "cpu": "1000m"
        },
        "requests": {
          "memory": "512Mi",
          "cpu": "250m"
        }
      }
    }
  ],
  
  "volumes": [
    {
      "name": "uploads",
      "mountPath": "/app/uploads",
      "size": "10Gi"
    },
    {
      "name": "logs",
      "mountPath": "/app/logs",
      "size": "5Gi"
    }
  ],
  
  "cron": [
    {
      "name": "sync-jobs",
      "schedule": "0 */6 * * *",
      "command": "node dist/scripts/sync-jobs.js"
    },
    {
      "name": "send-alerts",
      "schedule": "0 9 * * *",
      "command": "node dist/scripts/send-alerts.js"
    },
    {
      "name": "cleanup-expired",
      "schedule": "0 3 * * *",
      "command": "node dist/scripts/cleanup.js"
    },
    {
      "name": "backup-database",
      "schedule": "0 2 * * *",
      "command": "node dist/scripts/backup-db.js"
    }
  ]
}